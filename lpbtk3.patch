From 6aa71fc87c68bf511ee2660dc43ce59a4095cb56 Mon Sep 17 00:00:00 2001
From: sonicxml <sonicxml@gmail.com>
Date: Sat, 21 Jul 2012 19:12:24 -0400
Subject: [PATCH] Long press to kill Bring changes done in cm7 to jb. -
 Vibrate on press - Show message -
 http://review.cyanogenmod.com/#change,5191,patchset=2

---
 core/res/res/values/strings.xml                             |    3 +++
 .../android/internal/policy/impl/PhoneWindowManager.java    |   11 +++++++++--
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/core/res/res/values/strings.xml b/core/res/res/values/strings.xml
index a797459..3662ad9 100755
--- a/core/res/res/values/strings.xml
+++ b/core/res/res/values/strings.xml
@@ -3583,4 +3583,7 @@
     <string name="eos_globalactions_reboot_recovery">Recovery</string>
     <string name="eos_globalactions_reboot_safemode">Safe Mode</string>
     <string name="reboot_title">Reboot</string>
+
+    <!--Application killed toast -->
+    <string name="app_killed_message">Hasta la vista, baby!</string>
 </resources>
diff --git a/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java b/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java
index 451ca7b..4a5b522 100755
--- a/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java
+++ b/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java
@@ -143,6 +143,7 @@
 import android.view.accessibility.AccessibilityEvent;
 import android.view.animation.Animation;
 import android.view.animation.AnimationUtils;
+import android.widget.Toast;
 
 import java.io.File;
 import java.io.FileReader;
@@ -767,6 +768,7 @@ public void run() {
     Runnable mBackLongPress = new Runnable() {
         public void run() {
             try {
+		performHapticFeedbackLw(null, HapticFeedbackConstants.LONG_PRESS, false);
                 IActivityManager mgr = ActivityManagerNative.getDefault();
                 List<RunningAppProcessInfo> apps = mgr.getRunningAppProcesses();
                 for (RunningAppProcessInfo appInfo : apps) {
@@ -775,8 +777,13 @@ public void run() {
                     // root, phone, etc.)
                     if (uid >= Process.FIRST_APPLICATION_UID && uid <= Process.LAST_APPLICATION_UID
                             && appInfo.importance == RunningAppProcessInfo.IMPORTANCE_FOREGROUND) {
+			Toast.makeText(mContext, R.string.app_killed_message, Toast.LENGTH_SHORT).show();
                         // Kill the entire pid
-                        Process.killProcess(appInfo.pid);
+			if (appInfo.pkgList!=null && (apps.size() > 0)){
+				mgr.forceStopPackage(appInfo.pkgList[0]);
+			} else{
+				Process.killProcess(appInfo.pid);	
+			}
                         break;
                     }
                 }
@@ -1926,7 +1933,7 @@ public long interceptKeyBeforeDispatching(WindowState win, KeyEvent event, int p
             	if (Settings.Secure.getInt(mContext.getContentResolver(),
 			Settings.Secure.KILL_APP_LONGPRESS_BACK, 0) == 1) {
                 	if (down && repeatCount == 0) {
-                    		mHandler.postDelayed(mBackLongPress, 2000);
+                    		mHandler.postDelayed(mBackLongPress, ViewConfiguration.getGlobalActionKeyTimeout());
                 	}
 		}
         } else if (keyCode == KeyEvent.KEYCODE_ASSIST) {
-- 
1.7.10

